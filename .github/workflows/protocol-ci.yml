name: protocol-ci

on:
  push:
    branches: [main]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Validate protocol base
        run: |
          python scripts/validate_identity_protocol.py

      - name: Compile runtime brief
        run: |
          python scripts/compile_identity_runtime.py

      - name: Validate manifest + discovery
        run: |
          python scripts/validate_identity_manifest.py
          python scripts/test_identity_discovery_contract.py >/tmp/identity_discovery_contract.protocol_repo.json

      - name: Validate required runtime gates across active identities
        run: |
          IDS=$(python - <<'PY'
import yaml
from pathlib import Path
c=yaml.safe_load(Path('identity/catalog/identities.yaml').read_text())
ids=[x['id'] for x in c.get('identities',[]) if isinstance(x,dict) and str(x.get('status','')).lower()=='active']
if not ids:
    d=c.get('default_identity')
    if d:
        ids=[d]
print(' '.join(ids))
PY
)
          echo "active identities: $IDS"
          for ID in $IDS; do
            python scripts/validate_identity_runtime_contract.py --identity-id "$ID"
            python scripts/validate_identity_upgrade_prereq.py --identity-id "$ID"
            python scripts/validate_identity_update_lifecycle.py --identity-id "$ID"
            python scripts/validate_identity_trigger_regression.py --identity-id "$ID"
            python scripts/validate_identity_learning_loop.py --identity-id "$ID"
          done

      - name: Identity creator protocol checks
        run: |
          bash skills/identity-creator/scripts/validate_identity_protocol.sh .

      - name: Check generated runtime brief is up to date
        run: |
          git diff --exit-code -- identity/runtime/IDENTITY_COMPILED.md
