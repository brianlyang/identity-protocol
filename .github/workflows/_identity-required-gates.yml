name: identity-required-gates

on:
  workflow_call:

jobs:
  validate-identity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Validate protocol base
        run: python3 scripts/validate_identity_protocol.py

      - name: Validate governance snapshot index
        run: python3 scripts/validate_audit_snapshot_index.py

      - name: Validate changelog update for significant changes
        env:
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PUSH_BEFORE_SHA: ${{ github.event.before }}
          CURRENT_SHA: ${{ github.sha }}
        run: |
          if [ -n "${PR_BASE_SHA}" ] && [ -n "${PR_HEAD_SHA}" ]; then
            BASE_SHA="${PR_BASE_SHA}"
            HEAD_SHA="${PR_HEAD_SHA}"
          elif [ -n "${PUSH_BEFORE_SHA}" ] && [ "${PUSH_BEFORE_SHA}" != "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="${PUSH_BEFORE_SHA}"
            HEAD_SHA="${CURRENT_SHA}"
          else
            BASE_SHA="$(git rev-parse HEAD~1)"
            HEAD_SHA="$(git rev-parse HEAD)"
          fi
          python3 scripts/validate_changelog_updated.py --base "${BASE_SHA}" --head "${HEAD_SHA}"

      - name: Compile runtime
        run: python3 scripts/compile_identity_runtime.py

      - name: Validate identity manifest + discovery
        run: |
          python3 scripts/validate_identity_manifest.py
          python3 scripts/test_identity_discovery_contract.py >/tmp/identity_discovery_contract.protocol_repo.json

      - name: Validate required runtime gates across active identities
        run: |
          if [ -n "${{ github.event.pull_request.base.sha }}" ] && [ -n "${{ github.event.pull_request.head.sha }}" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          elif [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"
          else
            BASE_SHA="$(git rev-parse HEAD~1)"
            HEAD_SHA="$(git rev-parse HEAD)"
          fi
          IDS=$(python -c "import yaml;from pathlib import Path;c=yaml.safe_load(Path('identity/catalog/identities.yaml').read_text());ids=[x['id'] for x in c.get('identities',[]) if isinstance(x,dict) and str(x.get('status','')).lower()=='active'];d=c.get('default_identity');print(' '.join(ids or ([d] if d else [])))")
          echo "active identities: $IDS"
          for ID in $IDS; do
            python3 scripts/validate_identity_runtime_contract.py --identity-id "$ID"
            python3 scripts/validate_identity_upgrade_prereq.py --identity-id "$ID"
            python3 scripts/validate_identity_update_lifecycle.py --identity-id "$ID"
            python3 scripts/validate_identity_trigger_regression.py --identity-id "$ID"
            python3 scripts/validate_identity_learning_loop.py --identity-id "$ID"
            python3 scripts/validate_identity_collab_trigger.py --identity-id "$ID" --self-test
            python3 scripts/validate_agent_handoff_contract.py --identity-id "$ID" --self-test
            python3 scripts/export_route_quality_metrics.py --identity-id "$ID"
            python3 scripts/validate_identity_orchestration_contract.py --identity-id "$ID"
            python3 scripts/validate_identity_knowledge_contract.py --identity-id "$ID" --self-test
            python3 scripts/validate_identity_experience_feedback.py --identity-id "$ID" --self-test
            python3 scripts/validate_identity_install_safety.py --identity-id "$ID"
            python3 scripts/validate_identity_experience_feedback_governance.py --identity-id "$ID"
            python3 scripts/validate_identity_self_upgrade_enforcement.py --identity-id "$ID" --base "${BASE_SHA}" --head "${HEAD_SHA}"
            python3 scripts/execute_identity_upgrade.py --identity-id "$ID" --mode review-required --out-dir /tmp/identity-upgrade-reports
            UPGRADE_REPORT=$(ls -1t /tmp/identity-upgrade-reports/identity-upgrade-exec-"$ID"-*.json | head -n 1)
            python3 scripts/validate_identity_capability_arbitration.py --identity-id "$ID" --self-test --upgrade-report "$UPGRADE_REPORT"
            python3 scripts/validate_identity_ci_enforcement.py --identity-id "$ID"
          done

      - name: Identity creator protocol checks
        run: bash skills/identity-creator/scripts/validate_identity_protocol.sh .

      - name: Check generated runtime brief is up to date
        run: git diff --exit-code -- identity/runtime/IDENTITY_COMPILED.md
